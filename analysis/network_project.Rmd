---
title: "network_project"
author: "KiseokUchicago"
date: "2021-05-28"
output: workflowr::wflow_html
editor_options:
  chunk_output_type: console
---


```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=11, fig.height=9,
                      error=TRUE, echo=TRUE, eval=TRUE, warning=FALSE, message=FALSE)
```

## Final project analysis
## Project for ECEV 44500 Networks in Ecology and Evolution
Professor: **Mercedes Pascual**, **Sergio A. Alcala Corona** \
Student: **Kiseok Lee**

```{r}
# libraries
library(igraph)
library(tidygraph)
library(ggraph)
library(bipartite)
library(dplyr)
library(ggplot2)
library(ggrepel)
library(RColorBrewer)
library(vegan)
library(tidyverse)
library(magrittr)
library(reshape2)
library(gtools)
library(devtools)
library(ggpubr)
library(MASS)

## theme for ggplot
mytheme <- theme_bw() + 
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=10, family="serif"))+
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank(),panel.background=element_blank(),panel.border=element_blank(),plot.background=element_blank()) +
  theme(axis.ticks = element_line(size = 1.1))
  
mytheme_2d <- theme_bw() + 
  theme(plot.title = element_text(size = 19,hjust = 0.5, family="serif")) + 
  theme(axis.title.x = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.title.y = element_text(size = 17,hjust = 0.5, family="serif")) + 
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=13, family="serif"))+
  theme(axis.text.y = element_text(size=13, family="serif"))+
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank(),panel.background=element_blank(),plot.background=element_blank()) +
  theme(axis.ticks = element_line(size = 1.1))


# color collection
my_color_collection <- c(
  "#CBD588", "#5F7FC7", "orange", "#AD6F3B", "#673770", 
  "#D14285", "#652926", "#C84248", "#8569D5", "#5E738F",
  "#D1A33D", "#8A7C64", "#599861","#616163", "#FFCDB2",
  "#6D9F71", "#242F40",
   "#CCA43B", "#F92A82", "#ED7B84", "#7EB77F", 
  "#DEC4A1", "#E5D1D0", '#0E8482', '#C9DAEA', '#337357', 
  '#95C623', '#E55812', '#04471C', '#F2D7EE', '#D3BCC0', 
  '#A5668B', '#69306D', '#0E103D', '#1A535C', '#4ECDC4', 
  '#F7FFF7', '#FF6B6B', '#FFE66D', '#6699CC', '#FFF275', 
  '#FF8C42', '#FF3C38', '#A23E48', '#000000', '#CF5C36', 
  '#EEE5E9', '#7C7C7C', '#EFC88B', '#2E5266', '#6E8898', 
  '#9FB1BC', '#D3D0CB', '#E2C044', '#5BC0EB', '#FDE74C', 
  '#9BC53D', '#E55934', '#FA7921', "#CD9BCD", "#508578", "#DA5724")

```


## 1. Import data
Microbiome sequence of domesticated/wild rice seed (bacteria & Fungi) (https://microbiomejournal.biomedcentral.com/articles/10.1186/s40168-020-00805-0)
```{r}
# domesticated rice seed microbiome
domestic_links <- read.csv('data/2_0.3_edge_dom.css.ss.5.tsv',sep="\t", header=T)
b_domestic_links <- read.csv('data/5_0.3_edge_dom.phy.ss.5.tsv',sep="\t", header=T)
f_domestic_links <- read.csv('data/8_0.3_edge_dom.fun.ss.5.tsv',sep="\t", header=T)

# wild rice seed microbiome
wild_links <- read.csv('data/3_0.3_edge_wil.css.ss.5.tsv',sep="\t", header=T)
b_wild_links <- read.csv('data/6_0.3_edge_wil.phy.ss.5.tsv',sep="\t", header=T) # bacteria
f_wild_links <- read.csv('data/9_0.3_edge_wil.fun.ss.5.tsv',sep="\t", header=T) # fungi

# microbial network of wild rice seed endophytes
domestic_web <- graph.data.frame(domestic_links, directed = F)
b_domestic_web <- graph.data.frame(b_domestic_links, directed = F) # bacteria
f_domestic_web <- graph.data.frame(f_domestic_links, directed = F) # fungi

# microbial network of wild rice seed endophytes
wild_web <- graph.data.frame(wild_links, directed = F)
b_wild_web <- graph.data.frame(b_wild_links, directed = F) # bacteria
f_wild_web <- graph.data.frame(f_wild_links, directed = F) # fungi

plot(wild_web, vertex.size=5, vertex.label=NA, main="Bacteria & Fungi-Wild rice")
plot(b_wild_web, vertex.size=5, vertex.label=NA, main="Bacteria-Wild rice")
plot(f_wild_web, vertex.size=5, vertex.label=NA, main="Fungi-Wild rice")
```

## 2. Centrality distribution
We are doing centrality analysis to see if there is descriptive difference.

## 2.1. Degree
```{r}
## Degree histogram
plot_degree <- function(wild_web, title="Wild rice seed microbiome"){
  d.wild <- igraph::degree(wild_web)
  ggplot(as.data.frame(d.wild), aes(d.wild)) + geom_bar(fill='lightblue') +
    ylab("frequency \n") +
    xlab("\n Degree") +
    # scale_x_continuous(breaks=seq(1,8,1))+
    ggtitle(paste0(title," \n")) +
    mytheme
}

# log-log degree distributions
plot_log_degree <- function(wild_web){
  dd.wild <- degree.distribution(wild_web)
  d.wild <- igraph::degree(wild_web)
  d <- 1:max(d.wild)-1
  ind <- (dd.wild != 0)
  plot(d[ind],dd.wild[ind], log='xy', col='blue',
       xlab="Log-Degree", ylab="Log-Intensity",
       main="Log-Log degree distribution")
}

# Wild
p_w <- plot_degree(wild_web, title="Wild microbiome (Bacteria+Fungi)")
p_bw <- plot_degree(b_wild_web, title="Wild bacterial microbiome")
p_fw <- plot_degree(f_wild_web, title="Wild fungal microbiome")

ggarrange(p_bw, p_fw + rremove("ylab"), p_w, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Wild Bacteria
plot_log_degree(b_wild_web)
# Wild Fungi
plot_log_degree(f_wild_web)
# Wild Bacteria + fungi
plot_log_degree(wild_web)

# Domesticated
p_d <- plot_degree(domestic_web, title="Domesticated microbiome (Bacteria+Fungi)")
p_bd <- plot_degree(b_domestic_web, title="Domesticated bacterial microbiome")
p_fd <- plot_degree(f_domestic_web, title="Domesticated fungal microbiome")

ggarrange(p_bd, p_fd + rremove("ylab"), p_d, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Domesticated Bacteria
plot_log_degree(b_domestic_web)
# Domesticated fungi
plot_log_degree(f_domestic_web)
# Domesticated Bacteria + fungi
plot_log_degree(domestic_web)

```

## 2.2. Betweenness centrality

```{r}
## Betweenness histogram
plot_betweenness <- function(wild_web, title="Wild rice seed microbiome"){
  bt.wild <- igraph::betweenness(wild_web)
  df_wild <- as.data.frame(bt.wild)
  ggplot(df_wild, aes(bt.wild)) + geom_bar(stat="bin",fill='lightblue',bins=40) +
    ylab("frequency \n") +
    xlab("\n Betweenness") +
    # scale_x_continuous(breaks=seq(1,8,1))+
    ggtitle(paste0(title," \n")) +
    mytheme
}

# log-log betweenness distributions
plot_log_betweenness <- function(wild_web, bin_interval=500){
  bt.wild <- igraph::betweenness(wild_web)
  bin_interval = bin_interval
  bt_dist <- as.data.frame(table(cut(bt.wild, breaks=seq(0,max(bt.wild), by=bin_interval))))
  # hist(bt_dist$Freq)
  colnames(bt_dist)
  freq_sum = sum(bt_dist$Freq)
  bt_dist$density <- bt_dist$Freq / freq_sum
  btd.wild <- bt_dist$density # betweenness centrality distribution
  bt <- seq(0,max(bt.wild),bin_interval)[-length(seq(0,max(bt.wild),bin_interval))] # x axis
  ind <- (btd.wild != 0)
  plot(bt[ind], btd.wild[ind], log='xy', col='blue',
       xlab="Log-Betweenness", ylab="Log-Intensity",
       main="Log-Log betweenness distribution")
}

# Wild
p_bt_w <- plot_betweenness(wild_web, title="Wild microbiome (Bacteria+Fungi)")
p_bt_bw <- plot_betweenness(b_wild_web, title="Wild bacterial microbiome")
p_bt_fw <- plot_betweenness(f_wild_web, title="Wild fungal microbiome")

ggarrange(p_bt_bw, p_bt_fw + rremove("ylab"), p_bt_w, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Wild Bacteria
plot_log_betweenness(b_wild_web, bin_interval=10)
# Wild Fungi
plot_log_betweenness(f_wild_web, bin_interval=200)
# Wild Bacteria + fungi
plot_log_betweenness(wild_web, bin_interval=500)

# Domesticated
p_bt_d <- plot_betweenness(domestic_web, title="Domesticated microbiome (Bacteria+Fungi)")
p_bt_bd <- plot_betweenness(b_domestic_web, title="Domesticated bacterial microbiome")
p_bt_fd <- plot_betweenness(f_domestic_web, title="Domesticated fungal microbiome")

ggarrange(p_bt_bd, p_bt_fd + rremove("ylab"), p_bt_d, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Domesticated Bacteria
plot_log_betweenness(b_domestic_web, bin_interval=10)
# Domesticated fungi
plot_log_betweenness(f_domestic_web, bin_interval=1)
# Domesticated Bacteria + fungi
plot_log_betweenness(domestic_web, bin_interval=70)
```


## 2.3. Eigenvector's centrality

```{r}
## Eigenvector centrality histogram
plot_eigenvector <- function(wild_web, title="Wild rice seed microbiome"){
  eig.wild <- igraph::eigen_centrality(wild_web)$vector
  df_wild <- as.data.frame(eig.wild)
  ggplot(df_wild, aes(eig.wild)) + geom_bar(stat="bin",fill='lightblue',bins=40) +
    ylab("frequency \n") +
    xlab("\n Eigenvector centrality") +
    # scale_x_continuous(breaks=seq(1,8,1))+
    ggtitle(paste0(title," \n")) +
    mytheme
}

# log-log eigenvector distributions
plot_log_eigenvector <- function(wild_web, bin_interval=0.00005){
  eig.wild <- igraph::eigen_centrality(wild_web)$vector
  bin_interval = bin_interval
  eig_dist <- as.data.frame(table(cut(eig.wild, breaks=seq(0,max(eig.wild), by=bin_interval))))
  # hist(eig_dist$Freq)
  colnames(eig_dist)
  freq_sum = sum(eig_dist$Freq)
  eig_dist$density <- eig_dist$Freq / freq_sum
  eigd.wild <- eig_dist$density # eigenvector centrality distribution
  eig <- seq(0,max(eig.wild),bin_interval)[-length(seq(0,max(eig.wild),bin_interval))] # x axis
  ind <- (eigd.wild != 0)
  plot(eig[ind], eigd.wild[ind], log='xy', col='blue',
       xlab="Log-Eigenvector centrality", ylab="Log-Intensity",
       main="Log-Log eigenvector distribution")
}

# Wild
p_eig_w <- plot_eigenvector(wild_web, title="Wild microbiome (Bacteria+Fungi)")
p_eig_bw <- plot_eigenvector(b_wild_web, title="Wild bacterial microbiome")
p_eig_fw <- plot_eigenvector(f_wild_web, title="Wild fungal microbiome")

ggarrange(p_eig_bw, p_eig_fw + rremove("ylab"), p_eig_w, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Wild Bacteria
plot_log_eigenvector(b_wild_web, bin_interval=0.00005)
# Wild Fungi
plot_log_eigenvector(f_wild_web, bin_interval=0.00005)
# Wild Bacteria + fungi
plot_log_eigenvector(wild_web, bin_interval=0.1)

# Domesticated
p_eig_d <- plot_eigenvector(domestic_web, title="Domesticated microbiome (Bacteria+Fungi)")
p_eig_bd <- plot_eigenvector(b_domestic_web, title="Domesticated bacterial microbiome")
p_eig_fd <- plot_eigenvector(f_domestic_web, title="Domesticated fungal microbiome")

ggarrange(p_eig_bd, p_eig_fd + rremove("ylab"), p_eig_d, # + rremove("x.text") 
          labels = c("A", "B", "C"),
          ncol = 2, nrow = 2)

# Domesticated Bacteria
plot_log_eigenvector(b_domestic_web, bin_interval=0.00005)
# Domesticated fungi
plot_log_eigenvector(f_domestic_web, bin_interval=0.00005)
# Domesticated Bacteria + fungi
plot_log_eigenvector(domestic_web, bin_interval=0.1)
```

## 2.4. Plot together

Wild rice seed microbiome
```{r}
# (1-1) Wild - only bacteria
# Normalize
D_wb <- igraph::degree(b_wild_web, normalized = T) 
BC_wb <- igraph::betweenness(b_wild_web, directed = F, normalized = T)
EC_wb <- igraph::eigen_centrality(b_wild_web, directed = F, scale = T)$vector

df_cen_wb <- data.frame(Degree=D_wb, Betweenness=BC_wb, Eigen_centrality=EC_wb)

library(scatterplot3d)
# scatterplot3d(df_cen_wb, pch = 16, color="steelblue", angle = 29, type="h")
s3d <- scatterplot3d(df_cen_wb, pch = 16, color="steelblue", angle = 29, type="h")
text(s3d$xyz.convert(df_cen_wb), labels = rownames(df_cen_wb),
     cex= 0.65, col = "red")

# (1-2) Wild - bacteria + fungi
# Normalize
D_w <- igraph::degree(wild_web, normalized = T) 
BC_w <- igraph::betweenness(wild_web, directed = F, normalized = T)
EC_w <- igraph::eigen_centrality(wild_web, directed = F, scale = T)$vector

df_cen_w <- data.frame(Degree=D_w, Betweenness=BC_w, Eigen_centrality=EC_w)

library(scatterplot3d)
# scatterplot3d(df_cen_w, pch = 16, color="steelblue", angle = 29, type="h")
s3d <- scatterplot3d(df_cen_w, pch = 16, color="steelblue", angle = 29, type="h")
text(s3d$xyz.convert(df_cen_w), labels = rownames(df_cen_w),
     cex= 0.65, col = "red")
```

Domesticated rice seed microbiome
```{r}
# (1-1) Domesticated - only bacteria
# Normalize
D_db <- igraph::degree(b_domestic_web, normalized = T) 
BC_db <- igraph::betweenness(b_domestic_web, directed = F, normalized = T)
EC_db <- igraph::eigen_centrality(b_domestic_web, directed = F, scale = T)$vector

df_cen_db <- data.frame(Degree=D_db, Betweenness=BC_db, Eigen_centrality=EC_db)

library(scatterplot3d)
scatterplot3d(df_cen_db, pch = 16, color="steelblue", angle = 29, type="h")
s3d <- scatterplot3d(df_cen_db, pch = 16, color="steelblue", angle = 29, type="h")
text(s3d$xyz.convert(df_cen_db), labels = rownames(df_cen_db),
     cex= 0.65, col = "red")

# (1-2) Domesticated - bacteria + fungi
# Normalize
D_d <- igraph::degree(domestic_web, normalized = T) 
BC_d <- igraph::betweenness(domestic_web, directed = F, normalized = T)
EC_d <- igraph::eigen_centrality(domestic_web, directed = F, scale = T)$vector

df_cen_d <- data.frame(Degree=D_d, Betweenness=BC_d, Eigen_centrality=EC_d)

library(scatterplot3d)
scatterplot3d(df_cen_d, pch = 16, color="steelblue", angle = 29, type="h")
s3d <- scatterplot3d(df_cen_d, pch = 16, color="steelblue", angle = 29, type="h")
text(s3d$xyz.convert(df_cen_d), labels = rownames(df_cen_d),
     cex= 0.65, col = "red")
```

## 2.5. Change of hub species

Betweenness and degree centrality
```{r}
# 2D plotting with BT and Degree

plot_degree_betweenness <- function(df_cen_wb, title="Only Bacteria (Wild rice)", label_thresh=0.5){
  # Label bacteria and fungi to differ color
  df_cen_wb$Bacteria <- ifelse( substr(rownames(df_cen_wb),1,1)=="B","Bacteria","Fungi")
  # Label subset higher that top 50% in both Degree and Betweenness centrality
  label_thresh = label_thresh
  label_cen_wb <- subset(df_cen_wb, (Degree >= max(df_cen_wb$Degree)*label_thresh) & (Betweenness >= max(df_cen_wb$Betweenness)*label_thresh))
  # Plot only bacteria
  ggplot(df_cen_wb, aes(x=Degree, y=Betweenness)) +
    xlab('\n Degree (Normalized)')+
    ylab("Betweenness (Normalized) \n") +
    geom_point(aes(fill = Bacteria), shape = 21 ,size=5, alpha=0.9) +
    scale_fill_manual(labels = c('Bacteria','Fungi'), values = c('Bacteria'= "#FF8300", 'Fungi'='#BF4AFF'))+
    ggtitle(paste0(title," \n")) +
    scale_x_continuous(limits = c(0, max(df_cen_wb$Degree))) +
    scale_y_continuous(limits = c(0, max(df_cen_wb$Betweenness))) +
    theme(legend.text=element_text(size=13)) + 

    geom_hline(yintercept=max(df_cen_wb$Betweenness)*0.5, color="maroon4", linetype='dotted')+
    geom_vline(xintercept=max(df_cen_wb$Degree)*0.5, color="maroon4", linetype='dotted')+
    # theme(legend.position="top") +
    # theme(legend.title=element_blank()) +
    guides(colour = guide_legend(override.aes = list(size=8), reverse = TRUE))+
    guides(size=FALSE) +
    mytheme_2d +
    geom_text_repel(data=label_cen_wb ,aes(label=rownames(label_cen_wb)), size=4, family="serif")
}

# wild
plot_degree_betweenness(df_cen_wb, title="Only Bacteria (Wild rice)", label_thresh=0.4)
plot_degree_betweenness(df_cen_w, title="Bacteria + Fungi (Wild rice)", label_thresh=0.4)
# domesticated
plot_degree_betweenness(df_cen_db, title="Only Bacteria (Domesticated rice)", label_thresh=0.35)
plot_degree_betweenness(df_cen_d, title="Bacteria + Fungi (Domesticated rice)", label_thresh=0.35)

```


## 2.6. Comparison of each centrality (before vs after merging kingdom)
Degree
```{r}
# Investigate centrality for bacterial species before vs after merging kingdom
# (1) Degree
plot_degree_change <- function(df_cen_wb,df_cen_w, title = "Wild"){
  # make rownames to column for left join
  df_cen_wb <- tibble::rownames_to_column(df_cen_wb, var="OTU")
  df_cen_w <- tibble::rownames_to_column(df_cen_w, var="OTU")
  # left join
  df_cen_w_comp <- df_cen_wb %>% left_join(df_cen_w, by=c("OTU"="OTU"))
    
  ggplot(df_cen_w_comp, aes(x=Degree.x, y=Degree.y)) + geom_point() +
    xlab('\n Degree in bacteria-only network')+
    ylab("Degree in bacterial + fungal network \n") +
    ggtitle(paste0(title," \n")) +
    scale_x_continuous(limits = c(0, max(df_cen_w_comp$Degree.x))) +
    scale_y_continuous(limits = c(0, max(df_cen_w_comp$Degree.y))) +
    mytheme_2d +
    stat_smooth(method="loess", colour="red") +
    # stat_smooth(method='lm', se=FALSE, colour="orange") +
    geom_abline(intercept=0, slope=1, color="maroon4", linetype='dotted', size=1.1 )
}

# Wild
plot_degree_change(df_cen_wb,df_cen_w, title = "Change of degree (Wild)")
# Domesticated
plot_degree_change(df_cen_db,df_cen_d, title = "Change of degree (Domesticated)")

## Now plot the above 2 plots in 1 plot
# Degree (Wild + dom)
cen_wb <- tibble::rownames_to_column(df_cen_wb, var="OTU")
cen_w <- tibble::rownames_to_column(df_cen_w, var="OTU")
cen_db <- tibble::rownames_to_column(df_cen_db, var="OTU")
cen_d <- tibble::rownames_to_column(df_cen_d, var="OTU")
# left join
df_cen_w_comp <- cen_wb %>% left_join(cen_w, by=c("OTU"="OTU")) %>% mutate(Network="Wild")
df_cen_d_comp <- cen_db %>% left_join(cen_d, by=c("OTU"="OTU")) %>% mutate(Network="Domesticated")
df_cen_comp <- rbind(df_cen_w_comp,df_cen_d_comp)
df_cen_comp$Network <- factor(df_cen_comp$Network, levels = c("Wild","Domesticated"))

# plot
ggplot(df_cen_comp, aes(x=Degree.x, y=Degree.y)) + 
  geom_point(aes(color = Network), shape = 16 ,size=2, alpha=0.9) +
  scale_color_manual(values = c("red2", 'blue3'))+
  xlab('\n Degree in bacteria-only network')+
  ylab("Degree in bacterial + fungal network \n") +
  ggtitle(paste0("Change of degree"," \n")) +
  scale_x_continuous(limits = c(0, max(df_cen_comp$Degree.x))) +
  scale_y_continuous(limits = c(0, max(df_cen_comp$Degree.y))) +
  mytheme_2d +
  stat_smooth(method="loess", aes(color=Network)) +
  # stat_smooth(method='lm', se=FALSE, colour="orange") +
  geom_abline(intercept=0, slope=1, color="maroon4", linetype='dotted', size=1.1)

```

Betweenness
```{r}
# (2) Betweenness
plot_betweenness_change <- function(df_cen_wb,df_cen_w, title = "Change of betweenness (Wild)"){
  # make rownames to column for left join
  df_cen_wb <- tibble::rownames_to_column(df_cen_wb, var="OTU")
  df_cen_w <- tibble::rownames_to_column(df_cen_w, var="OTU")
  # left join
  df_cen_w_comp <- df_cen_wb %>% left_join(df_cen_w, by=c("OTU"="OTU"))
    
  ggplot(df_cen_w_comp, aes(x=Betweenness.x, y=Betweenness.y)) + geom_point() +
    xlab('\n Betweenness in bacteria-only network')+
    ylab("Betweenness in bacterial + fungal network \n") +
    ggtitle(paste0(title," \n")) +
    scale_x_continuous(limits = c(0, max(df_cen_w_comp$Betweenness.x))) +
    scale_y_continuous(limits = c(0, max(df_cen_w_comp$Betweenness.y))) +
    mytheme_2d +
    stat_smooth(method="loess", colour="red") +
    # stat_smooth(method='lm', se=FALSE, colour="orange") +
    geom_abline(intercept=0, slope=1, color="maroon4", linetype='dotted', size=1.1 )
}

# Wild
plot_betweenness_change(df_cen_wb,df_cen_w, title = "Change of betweenness (Wild)")
# Domesticated
plot_betweenness_change(df_cen_db,df_cen_d, title = "Change of betweenness (Domesticated)")


## Now plot the above 2 plots in 1 plot
# Betweenness (Wild + dom)
# plot
ggplot(df_cen_comp, aes(x=Betweenness.x, y=Betweenness.y)) + 
  geom_point(aes(color = Network), shape = 16 ,size=2, alpha=0.9) +
  scale_color_manual(values = c("red2", 'blue3'))+
  xlab('\n Betweenness in bacteria-only network')+
  ylab("Betweenness in bacterial + fungal network \n") +
  ggtitle(paste0("Change of Betweenness"," \n")) +
  # scale_x_continuous(limits = c(0, max(df_cen_comp$Degree.x))) +
  scale_y_continuous(limits = c(0, max(df_cen_comp$Degree.y))) +
  mytheme_2d +
  stat_smooth(method="loess", aes(color=Network)) +
  # stat_smooth(method='lm', se=FALSE, colour="orange") +
  geom_abline(intercept=0, slope=1, color="maroon4", linetype='dotted', size=1.1)

```

Eigenvector's centrality
```{r}
# (3) Eigenvector's centrality
plot_eigen_centrality_change <- function(df_cen_wb,df_cen_w, title = "Change of Eigen_centrality (Wild)"){
  # make rownames to column for left join
  df_cen_wb <- tibble::rownames_to_column(df_cen_wb, var="OTU")
  df_cen_w <- tibble::rownames_to_column(df_cen_w, var="OTU")
  # left join
  df_cen_w_comp <- df_cen_wb %>% left_join(df_cen_w, by=c("OTU"="OTU"))
    
  ggplot(df_cen_w_comp, aes(x=Eigen_centrality.x, y=Eigen_centrality.y)) + geom_point() +
    xlab('\n Eigen_centrality in bacteria-only network')+
    ylab("Eigen_centrality in bacterial + fungal network \n") +
    ggtitle(paste0(title," \n")) +
    scale_x_continuous(limits = c(0, max(df_cen_w_comp$Eigen_centrality.x))) +
    scale_y_continuous(limits = c(0, max(df_cen_w_comp$Eigen_centrality.y))) +
    mytheme_2d +
    # stat_smooth(method="loess", colour="red") +
    # stat_smooth(method='lm', se=FALSE, colour="orange") +
    geom_abline(intercept=0, slope=1, color="maroon4", linetype='dotted', size=1.1 )
}

# Wild
plot_eigen_centrality_change(df_cen_wb,df_cen_w, title = "Change of Eigen_centrality (Wild)")
# Domesticated
plot_eigen_centrality_change(df_cen_db,df_cen_d, title = "Change of Eigen_centrality (Domesticated)")
```


## 3. Robustness (Extinction experiment)
- Is bacterial+fungal network more robust compared to bacterial only network? \
- Are the trends different for wild and domesticated networks?

```{r}
# (1) Extinction scheme in the order of highest Degree to lowest

# function for getting largest connected component
largest_component <- function(wild_web){
  components <- igraph::clusters(wild_web)
  biggest_cluster_id <- which.max(components$csize)
  # ids
  vert_ids <- V(wild_web)[components$membership == biggest_cluster_id]
  # subgraph
  largest_component <- igraph::induced_subgraph(wild_web, vert_ids)
  return(largest_component)
}

# largest component 
lg_wild_web <- largest_component(wild_web)
# vertex count
vcount(lg_wild_web)

plot(lg_wild_web, vertex.size=5, vertex.label=NA, vertex.color='lightblue', edge.arrow.width=0.3, edge.arrow.curve=0.5)

# get vertex list of the largest component and get the degree for those nodes
lg_cen_w <- tibble::rownames_to_column(df_cen_w, var="Node") %>% filter(Node %in% V(lg_wild_web)$name)

# Set extinction order
set.seed(1)
lg_cen_w <- lg_cen_w[sample(1:dim(lg_cen_w)[1]),] # shuffling because there are nodes that have same degree
ext_order <- lg_cen_w %>% arrange(desc(Degree)) %>% dplyr::select(Node)
ext_order <- ext_order$Node

# set vectors that will become x and y of the 2D plot
lg_size_vec <- c(vcount(lg_wild_web))
remove_num_vec <- 0:vcount(lg_wild_web)

# Execute extinction
for (i in 1:vcount(lg_wild_web)){
  # print(i)
  # print(ext_order[i])
  # subtract the vertex in order one by one
  subtracted_web <- lg_wild_web - vertices(ext_order[1:i])
  # calculate the largest component
  subtracted_lg <- largest_component(subtracted_web)
  # print(paste0('size of largest component: ',vcount(subtracted_lg)))
  # append the size of largest component
  # if the size of the largest component is 1, it is regarded as 0 because no links exist.
  if (vcount(subtracted_lg) == 1){
    lg_size_vec <- c(lg_size_vec,0)
  } else{
    lg_size_vec <- c(lg_size_vec,vcount(subtracted_lg))
  }
}

lg_size_vec %>% length()
remove_num_vec %>% length()

# create dataframe
df_extinction <- tibble(Removed= remove_num_vec/vcount(lg_wild_web), Lg_size = lg_size_vec/vcount(lg_wild_web))

# plot 
ggplot(df_extinction, aes(x=Removed, y=Lg_size))+ #, group=name)) +
  geom_line(size=0.5) +
  ggtitle(paste0("Degree-based attack (Wild bacterial + fungal network)"," \n")) +
  xlab('\n Fraction of vertices removed')+
  ylab("Fractional size of largest component  \n") +
  mytheme_2d
```

Now do this for 1000 times and plot. Then we can get average.
```{r}
# Start from the beginning
# largest component 
lg_wild_web <- largest_component(wild_web)
# vertex count
vcount(lg_wild_web)
# get vertex list of the largest component and get the degree for those nodes
lg_cen_w <- tibble::rownames_to_column(df_cen_w, var="Node") %>% filter(Node %in% V(lg_wild_web)$name)

# set vectors that will become x and y of the 2D plot
lg_size_vec <- c()  # Y axis
remove_num_vec <- c()  # X axis
rand_num_vec <- c()  # line group to plot in ggplot (rand below)

# Loop 1000 times -> takes too long.. 50 times
for (rand in 1:50){
  # print(rand)
  # Set extinction order (shuffle and arrange from highest to lowest degree)
  lg_cen_w_rand <- lg_cen_w[sample(1:dim(lg_cen_w)[1]),] # shuffling because there are nodes that have same degree
  ext_order <- lg_cen_w_rand %>% arrange(desc(Degree)) %>% dplyr::select(Node)
  ext_order <- ext_order$Node
  
  # When no vertice is removed
  lg_size_vec <- c(lg_size_vec, vcount(lg_wild_web))
  remove_num_vec <- c(remove_num_vec, 0)
  rand_num_vec <- c(rand_num_vec, rand)
  
  # Execute extinction
  for (i in 1:vcount(lg_wild_web)){
    # Append rand_num_vec
    rand_num_vec <- c(rand_num_vec, rand)
    # Update remove_num_vec
    remove_num_vec <- c(remove_num_vec,i)
    
    # subtract the vertex in order one by one
    subtracted_web <- lg_wild_web - vertices(ext_order[1:i])
    # calculate the largest component
    subtracted_lg <- largest_component(subtracted_web)
    # append the size of largest component
      # if the size of the largest component is 1, it is regarded as 0 because no links exist.
    if (vcount(subtracted_lg) == 1){
      lg_size_vec <- c(lg_size_vec,0)
    } else{
      lg_size_vec <- c(lg_size_vec,vcount(subtracted_lg))
    }
  }
}

# create dataframe
df_extinction <- tibble(Removed= remove_num_vec/vcount(lg_wild_web), Lg_size = lg_size_vec/vcount(lg_wild_web), line_name = rand_num_vec)

# plot 
ggplot(df_extinction, aes(x=Removed, y=Lg_size, group=line_name)) +
  geom_line(size=0.5) +
  ggtitle(paste0("Degree-based attack (Wild bacterial + fungal network)"," \n")) +
  xlab('\n Fraction of vertices removed')+
  ylab("Fractional size of largest component  \n") +
  mytheme_2d

```

Now, wrap it into a function and implement.
```{r}

get_extinction_df <- function(wild_web, order="Degree", n_lines=10){ # order = "Betweenness", "Eigen_centrality", "Random"
  # calculate centrality
  D_w <- igraph::degree(wild_web, normalized = T) 
  BC_w <- igraph::betweenness(wild_web, directed = F, normalized = T)
  EC_w <- igraph::eigen_centrality(wild_web, directed = F, scale = T)$vector
  df_cen_w <- data.frame(Degree=D_w, Betweenness=BC_w, Eigen_centrality=EC_w)
  
  # largest component 
  lg_wild_web <- largest_component(wild_web)
  # vertex count
  vcount(lg_wild_web)
  # get vertex list of the largest component and get the degree for those nodes
  lg_cen_w <- tibble::rownames_to_column(df_cen_w, var="Node") %>% filter(Node %in% V(lg_wild_web)$name)
  
  # set vectors that will become x and y of the 2D plot
  lg_size_vec <- c()  # Y axis
  remove_num_vec <- c()  # X axis
  rand_num_vec <- c()  # line group to plot in ggplot (rand below)
  
  # Loop 1000 times -> takes too long.. 50 times
  n = n_lines
  for (rand in 1:n){
    # print(rand)
    # Set extinction order (shuffle and arrange from highest to lowest degree)
    lg_cen_w_rand <- lg_cen_w[sample(1:dim(lg_cen_w)[1]),] # shuffling because there are nodes that have same degree
    lg_cen_w_rand$Random <- 0
    ext_order <- lg_cen_w_rand %>% arrange(desc(!!sym(order))) %>% dplyr::select(Node)
    ext_order <- ext_order$Node
    
    # When no vertice is removed
    lg_size_vec <- c(lg_size_vec, vcount(lg_wild_web))
    remove_num_vec <- c(remove_num_vec, 0)
    rand_num_vec <- c(rand_num_vec, rand)
    
    # Execute extinction
    for (i in 1:vcount(lg_wild_web)){
      # Append rand_num_vec
      rand_num_vec <- c(rand_num_vec, rand)
      # Update remove_num_vec
      remove_num_vec <- c(remove_num_vec,i)
      
      # subtract the vertex in order one by one
      subtracted_web <- lg_wild_web - vertices(ext_order[1:i])
      # calculate the largest component
      subtracted_lg <- largest_component(subtracted_web)
      # append the size of largest component
        # if the size of the largest component is 1, it is regarded as 0 because no links exist.
      if (vcount(subtracted_lg) == 1){
        lg_size_vec <- c(lg_size_vec,0)
      } else{
        lg_size_vec <- c(lg_size_vec,vcount(subtracted_lg))
      }
    }
  }
  
  # create dataframe
  df_extinction <- tibble(Removed= remove_num_vec/vcount(lg_wild_web), Lg_size = lg_size_vec/vcount(lg_wild_web), line_name = rand_num_vec)
  return(df_extinction)
}


# plot function
plot_robustness <- function(df_extinction, title="Degree-based attack (Wild bacterial + fungal network)"){
  title = title
  ggplot(df_extinction, aes(x=Removed, y=Lg_size, group=line_name)) +
    geom_line(size=0.5, color="maroon") +
    ggtitle(paste0(title," \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    mytheme_2d
}


```

## 3.1. Generate data and plot robustness for each network
```{r}

# (1) Wild
# (1-1) Degree
df_ext_degree_wild <- get_extinction_df(wild_web, order="Degree", n_lines=50)
wd1 <- plot_robustness(df_ext_degree_wild, title="Degree-based attack (Wild)")
# (1-2) Betweenness
df_ext_bt_wild <- get_extinction_df(wild_web, order="Betweenness", n_lines=50)
wd2 <- plot_robustness(df_ext_bt_wild, title="Betweenness-based attack")
# (1-3) Eigen_centrality
df_ext_eigen_wild <- get_extinction_df(wild_web, order="Eigen_centrality", n_lines=50)
wd3 <- plot_robustness(df_ext_eigen_wild, title="Eigen_centrality-based attack")
# (1-4) Random
df_ext_random_wild <- get_extinction_df(wild_web, order="Random", n_lines=50)
wd4 <- plot_robustness(df_ext_random_wild, title="Random-based attack")
# plot 4 in 1
ggarrange(wd1, wd2 + rremove("ylab"), wd3 + rremove("ylab"), wd4 + rremove("ylab"),# + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 4, nrow = 1)

# (2) Wild - bacteria
# (2-1) Degree
df_ext_degree_wild_b <- get_extinction_df(b_wild_web, order="Degree", n_lines=50)
wb1 <- plot_robustness(df_ext_degree_wild_b, title="Degree-based attack (Wild bacterial)")
# (2-2) Betweenness
df_ext_bt_wild_b <- get_extinction_df(b_wild_web, order="Betweenness", n_lines=50)
wb2 <- plot_robustness(df_ext_bt_wild_b, title="Betweenness-based attack")
# (2-3) Eigen_centrality
df_ext_eigen_wild_b <- get_extinction_df(b_wild_web, order="Eigen_centrality", n_lines=50)
wb3 <- plot_robustness(df_ext_eigen_wild_b, title="Eigen_centrality-based attack")
# (2-4) Random
df_ext_random_wild_b <- get_extinction_df(b_wild_web, order="Random", n_lines=50)
wb4 <- plot_robustness(df_ext_random_wild_b, title="Random-based attack")
# plot 4 in 1
ggarrange(wb1, wb2 + rremove("ylab"), wb3 + rremove("ylab"), wb4 + rremove("ylab"),# + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 4, nrow = 1)

# (3) Domesticated
# (3-1) Degree
df_ext_degree_domestic <- get_extinction_df(domestic_web, order="Degree", n_lines=50)
dd1 <- plot_robustness(df_ext_degree_domestic, title="Degree-based attack (Domesticated)")
# (3-2) Betweenness
df_ext_bt_domestic <- get_extinction_df(domestic_web, order="Betweenness", n_lines=50)
dd2 <- plot_robustness(df_ext_bt_domestic, title="Betweenness-based attack")
# (3-3) Eigen_centrality
df_ext_eigen_domestic <- get_extinction_df(domestic_web, order="Eigen_centrality", n_lines=50)
dd3 <- plot_robustness(df_ext_eigen_domestic, title="Eigen_centrality-based attack")
# (3-4) Random
df_ext_random_domestic <- get_extinction_df(domestic_web, order="Random", n_lines=50)
dd4 <- plot_robustness(df_ext_random_domestic, title="Random-based attack")
# plot 4 in 1
ggarrange(dd1, dd2 + rremove("ylab"), dd3 + rremove("ylab"), dd4 + rremove("ylab"),# + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 4, nrow = 1)

# (4) Domesticated - bacteria
# (4-1) Degree
df_ext_degree_domestic_b <- get_extinction_df(b_domestic_web, order="Degree", n_lines=50)
db1 <- plot_robustness(df_ext_degree_domestic_b, title="Degree-based attack (Domesticated bacterial)")
# (4-2) Betweenness
df_ext_bt_domestic_b <- get_extinction_df(b_domestic_web, order="Betweenness", n_lines=50)
db2 <- plot_robustness(df_ext_bt_domestic_b, title="Betweenness-based attack")
# (3-3) Eigen_centrality
df_ext_eigen_domestic_b <- get_extinction_df(b_domestic_web, order="Eigen_centrality", n_lines=50)
db3 <- plot_robustness(df_ext_eigen_domestic_b, title="Eigen_centrality-based attack")
# (3-4) Random
df_ext_random_domestic_b <- get_extinction_df(b_domestic_web, order="Random", n_lines=50)
db4 <- plot_robustness(df_ext_random_domestic_b, title="Random-based attack")
# plot 4 in 1
ggarrange(db1, db2 + rremove("ylab"), db3 + rremove("ylab"), db4 + rremove("ylab"),# + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 4, nrow = 1)

# plot the average in 1 plot
plot_robustness_by_attack <- function(df_ext_degree_wild, df_ext_bt_wild, df_ext_eigen_wild, df_ext_random_wild, title = "Wild"){
  # 1. degree
  df_ext1 <- df_ext_degree_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Attack = "Degree")
  # 2. Bt
  df_ext2 <- df_ext_bt_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Attack = "Betweenness")
  # 3. Eigen
  df_ext3 <- df_ext_eigen_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Attack = "Eigen_centrality")
  # 4. Random
  df_ext4 <- df_ext_random_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Attack = "Random")
  
  df_ext_wild <- rbind(df_ext1, df_ext2, df_ext3, df_ext4)
  df_ext_wild$Attack <- factor(df_ext_wild$Attack, levels = c('Degree','Betweenness','Eigen_centrality',"Random"))
  
  ggplot(df_ext_wild, aes(x=Removed, y=Lg_size_median, group=Attack, color=Attack)) +
    geom_line(size=1) +
    ggtitle(paste0("Robustness curves (",title,") \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    mytheme_2d
}

# Wild
plot_robustness_by_attack(df_ext_degree_wild, df_ext_bt_wild, df_ext_eigen_wild, df_ext_random_wild, title="Wild")
# Wild -bac
plot_robustness_by_attack(df_ext_degree_wild_b, df_ext_bt_wild_b, df_ext_eigen_wild_b, df_ext_random_wild_b, title="Wild bacterial")

# Domesticated
plot_robustness_by_attack(df_ext_degree_domestic, df_ext_bt_domestic, df_ext_eigen_domestic, df_ext_random_domestic, title="Domesticated")
# Domesticated -bac
plot_robustness_by_attack(df_ext_degree_domestic_b, df_ext_bt_domestic_b, df_ext_eigen_domestic_b, df_ext_random_domestic_b, title="Domesticated bacterial")

```

## 3.2. Plot robustness for all network

Degree
```{r}
# 1. Degree
# plot different networks in 1 plot
plot_robustness_degree <- function(df_ext_degree_wild, df_ext_degree_wild_b, df_ext_degree_domestic, df_ext_degree_domestic_b, title = "Degree-based attack"){
  # Wild
  df_ext1 <- df_ext_degree_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
  # Wild-bac
  df_ext2 <- df_ext_degree_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
  # Domesticated
  df_ext3 <- df_ext_degree_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
  # Domesticated-bac
  df_ext4 <- df_ext_degree_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
  
  df_ext_degree <- rbind(df_ext1, df_ext2, df_ext3, df_ext4)
  df_ext_degree$Network <- factor(df_ext_degree$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))
  
  ggplot(df_ext_degree, aes(x=Removed, y=Lg_size_median, group=Network, color=Network)) +
    geom_line(size=1.5) +
    ggtitle(paste0(title," \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    # scale_fill_manual(labels = c('Wild-Bacterial-Fungal','Fungi'), values = c('Bacteria'= "#FF8300", 'Fungi'='#BF4AFF'))+
    scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
    mytheme_2d +
    theme(legend.position = c(.97, .97),
    legend.justification = c("right", "top"),
    legend.title  = element_blank(),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6))
}

# Plot
plot_robustness_degree(df_ext_degree_wild, df_ext_degree_wild_b, df_ext_degree_domestic, df_ext_degree_domestic_b, title = "Degree-based attack")

```

Betweenness
```{r}
# 2. Betweenness
# plot different networks in 1 plot
plot_robustness_bt <- function(df_ext_bt_wild, df_ext_bt_wild_b, df_ext_bt_domestic, df_ext_bt_domestic_b, title = "Betweenness-based attack"){
  # Wild
  df_ext1 <- df_ext_bt_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
  # Wild-bac
  df_ext2 <- df_ext_bt_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
  # Domesticated
  df_ext3 <- df_ext_bt_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
  # Domesticated-bac
  df_ext4 <- df_ext_bt_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
  
  df_ext_bt <- rbind(df_ext1, df_ext2, df_ext3, df_ext4)
  df_ext_bt$Network <- factor(df_ext_bt$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))
  
  ggplot(df_ext_bt, aes(x=Removed, y=Lg_size_median, group=Network, color=Network)) +
    geom_line(size=1.5) +
    ggtitle(paste0(title," \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    # scale_fill_manual(labels = c('Wild-Bacterial-Fungal','Fungi'), values = c('Bacteria'= "#FF8300", 'Fungi'='#BF4AFF'))+
    scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
    mytheme_2d +
    theme(legend.position = c(.97, .97),
    legend.justification = c("right", "top"),
    legend.title  = element_blank(),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6))
}

# Plot
plot_robustness_bt(df_ext_bt_wild, df_ext_bt_wild_b, df_ext_bt_domestic, df_ext_bt_domestic_b, title = "Betweenness-based attack")

```

Eigen_centrality
```{r}
# 3. Eigen_centrality
# plot different networks in 1 plot
plot_robustness_eigen <- function(df_ext_eigen_wild, df_ext_eigen_wild_b, df_ext_eigen_domestic, df_ext_eigen_domestic_b, title = "Eigen centrality-based attack"){
  # Wild
  df_ext1 <- df_ext_eigen_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
  # Wild-bac
  df_ext2 <- df_ext_eigen_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
  # Domesticated
  df_ext3 <- df_ext_eigen_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
  # Domesticated-bac
  df_ext4 <- df_ext_eigen_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
  
  df_ext_eigen <- rbind(df_ext1, df_ext2, df_ext3, df_ext4)
  df_ext_eigen$Network <- factor(df_ext_eigen$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))
  
  ggplot(df_ext_eigen, aes(x=Removed, y=Lg_size_median, group=Network, color=Network)) +
    geom_line(size=1.5) +
    ggtitle(paste0(title," \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    # scale_fill_manual(labels = c('Wild-Bacterial-Fungal','Fungi'), values = c('Bacteria'= "#FF8300", 'Fungi'='#BF4AFF'))+
    scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
    mytheme_2d +
    theme(legend.position = c(.97, .97),
    legend.justification = c("right", "top"),
    legend.title  = element_blank(),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6))
}

# Plot
plot_robustness_eigen(df_ext_eigen_wild, df_ext_eigen_wild_b, df_ext_eigen_domestic, df_ext_eigen_domestic_b, title = "Eigen centrality-based attack")

```

Random
```{r}
# 4. Random
# plot different networks in 1 plot
plot_robustness_random <- function(df_ext_random_wild, df_ext_random_wild_b, df_ext_random_domestic, df_ext_random_domestic_b, title = "Random-based attack"){
  # Wild
  df_ext1 <- df_ext_random_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
  # Wild-bac
  df_ext2 <- df_ext_random_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
  # Domesticated
  df_ext3 <- df_ext_random_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
  # Domesticated-bac
  df_ext4 <- df_ext_random_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
  
  df_ext_random <- rbind(df_ext1, df_ext2, df_ext3, df_ext4)
  df_ext_random$Network <- factor(df_ext_random$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))
  
  ggplot(df_ext_random, aes(x=Removed, y=Lg_size_median, group=Network, color=Network)) +
    geom_line(size=1.5) +
    ggtitle(paste0(title," \n")) +
    xlab('\n Fraction of vertices removed')+
    ylab("Fractional size of largest component  \n") +
    # scale_fill_manual(labels = c('Wild-Bacterial-Fungal','Fungi'), values = c('Bacteria'= "#FF8300", 'Fungi'='#BF4AFF'))+
    scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
    mytheme_2d +
    theme(legend.position = c(.97, .97),
    legend.justification = c("right", "top"),
    legend.title  = element_blank(),
    legend.box.just = "right",
    legend.margin = margin(6, 6, 6, 6))
}

# Plot
plot_robustness_random(df_ext_random_wild, df_ext_random_wild_b, df_ext_random_domestic, df_ext_random_domestic_b, title = "Random-based attack")

```

## 3.3. Calculate area under curve

```{r}
library(DescTools)

AUC(x=x, y=sin(x))


# Getting the data ready
## Degree - Wild
df_ext1 <- df_ext_degree_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
# Wild-bac
df_ext2 <- df_ext_degree_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
# Domesticated
df_ext3 <- df_ext_degree_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
# Domesticated-bac
df_ext4 <- df_ext_degree_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
# bind
df_ext_degree <- rbind(df_ext1, df_ext2, df_ext3, df_ext4) %>% mutate(Attack="Degree")

## BT - Wild
df_ext1 <- df_ext_bt_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
# Wild-bac
df_ext2 <- df_ext_bt_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
# Domesticated
df_ext3 <- df_ext_bt_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
# Domesticated-bac
df_ext4 <- df_ext_bt_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
# bind
df_ext_bt <- rbind(df_ext1, df_ext2, df_ext3, df_ext4) %>% mutate(Attack="Betweenness")

## Eigenvector - Wild
df_ext1 <- df_ext_eigen_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
# Wild-bac
df_ext2 <- df_ext_eigen_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
# Domesticated
df_ext3 <- df_ext_eigen_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
# Domesticated-bac
df_ext4 <- df_ext_eigen_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
# bind
df_ext_eigen <- rbind(df_ext1, df_ext2, df_ext3, df_ext4) %>% mutate(Attack="Eigen_centrality")

## Random - Wild
df_ext1 <- df_ext_random_wild %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial-Fungal")
# Wild-bac
df_ext2 <- df_ext_random_wild_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Wild-Bacterial")
# Domesticated
df_ext3 <- df_ext_random_domestic %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial-Fungal")
# Domesticated-bac
df_ext4 <- df_ext_random_domestic_b %>% group_by(Removed) %>% summarize(Lg_size_median = median(Lg_size)) %>% ungroup() %>% mutate(Network = "Domesticated-Bacterial")
# bind
df_ext_random <- rbind(df_ext1, df_ext2, df_ext3, df_ext4) %>% mutate(Attack="Random")

df_ext <- rbind(df_ext_degree, df_ext_bt, df_ext_eigen, df_ext_random)

# get AUC value (Area under curve)
mat_AUC <- matrix(rep(0,16),nrow=4, ncol=4)
row_vec = c("Wild-Bacterial-Fungal", "Wild-Bacterial", "Domesticated-Bacterial-Fungal", "Domesticated-Bacterial")
col_vec = c("Degree","Betweenness","Eigen_centrality","Random")

# Loop through col, row
for (i in 1:length(row_vec)){
  for (j in 1:length(col_vec)){
    # filter the points by the row(Network type) and column(Attack type) 
    df_ext_subset <- df_ext[(df_ext$Network==row_vec[i]) & (df_ext$Attack==col_vec[j]),]
    mat_AUC[i,j] = AUC(df_ext_subset$Removed,df_ext_subset$Lg_size_median)
  }
}

df_AUC <- data.frame(mat_AUC, row.names = row_vec)
colnames(df_AUC) <- col_vec

df_AUC
openxlsx::write.xlsx(df_AUC,"df_AUC.xlsx",row.names = T )

# Confirming everything is right
ext_w_degree <- df_ext %>% filter(Network == "Wild-Bacterial-Fungal", Attack=="Degree")
AUC(ext_w_degree$Removed,ext_w_degree$Lg_size_median)

ext_wb_degree <- df_ext %>% filter(Network == "Wild-Bacterial", Attack=="Degree")
AUC(ext_wb_degree$Removed,ext_wb_degree$Lg_size_median)

ext_w_bt <- df_ext %>% filter(Network == "Wild-Bacterial-Fungal", Attack=="Betweenness")
AUC(ext_w_bt$Removed,ext_w_bt$Lg_size_median)

ext_wb_bt <- df_ext %>% filter(Network == "Wild-Bacterial", Attack=="Betweenness")
AUC(ext_wb_bt$Removed,ext_wb_bt$Lg_size_median)



# Plotting for visualiztion
colnames(mat_AUC) <- col_vec
rownames(mat_AUC) <- row_vec

melt_AUC <- melt(mat_AUC)
colnames(melt_AUC) <- c("Network","Attack","AUC")

ggplot(melt_AUC, aes(x=Attack, y=AUC, group=Network, color=Network)) +
  geom_point(size =4) +
  geom_line(size=1.5) +
  ggtitle(paste0("Area under Robustness curve"," \n")) +
  xlab('\n Attack order')+
  ylab("AUC  \n") +
  scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
  mytheme_2d +
  theme(legend.title  = element_blank())+
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=17, family="serif"))

```

## 4. Various Metrics comparison

## 4.1. Connectance

```{r}
# connectance
ecount(wild_web)*2/(vcount(wild_web)^2) # multiply by 2 because undirected.

# install_github("clementviolet/omnivor")
library(omnivor)
omnivor::connectance(wild_web, loops = F, directed = F) # checking whether my calculation is correct

# store it in a vector
connectance_vec <- c()
row_vec
connectance_vec[1] <- omnivor::connectance(wild_web, loops = F, directed = F)
connectance_vec[2] <- omnivor::connectance(b_wild_web, loops = F, directed = F)
connectance_vec[3] <- omnivor::connectance(domestic_web, loops = F, directed = F)
connectance_vec[4] <- omnivor::connectance(b_domestic_web, loops = F, directed = F)
connectance_vec

# Randomization and null model to normalize summary metrics

# Use the connectance function below
connectance <- function(m){
  d <- sum(m>0)/(nrow(m)*ncol(m))
  return(d)
}

# curveball randomization  
null_curveball_simulation <- function(wild_web, connectance, num_iterations = 1000){
  null_model_curveball <- vegan::nullmodel(as_adjacency_matrix(wild_web), method = 'curveball')
  shuffled_curveball <- simulate(null_model_curveball, nsim = num_iterations, burnin = 1000) #Shuffle adjacency matrix
  connectance_curveball <- apply(shuffled_curveball, MARGIN = 3, connectance) # apply metric
  # P-value: Which proportion of the simulations have a Q value larger than the observed?
  P_value <- sum(connectance_vec[1] < connectance_curveball)/length(connectance_curveball)
  # if P-value is larger than 0.5, subtract it from 1
  if (P_value > 0.5){
    print("observed value is bigger than null value (did not say significant)")
    P_value <- 1 - P_value
  }
  print(paste0("P-value is: ",P_value))
  print(paste0("mean is: ", mean(connectance_curveball)))
  print(paste0("sd is: ", sd(connectance_curveball)))
  return(connectance_curveball)
}

connectance_sim1 <- null_curveball_simulation(wild_web, connectance, num_iterations = 1000)
connectance_sim2 <- null_curveball_simulation(b_wild_web, connectance, num_iterations = 1000)
connectance_sim3 <- null_curveball_simulation(domestic_web, connectance, num_iterations = 1000)
connectance_sim4 <- null_curveball_simulation(b_domestic_web, connectance, num_iterations = 1000)

# r00 randomization
null_r00_simulation <- function(wild_web, connectance, num_iterations = 1000){
  null_model_r00 <- vegan::nullmodel(as_adjacency_matrix(wild_web), method = 'r00')
  shuffled_r00 <- simulate(null_model_r00, nsim = num_iterations, burnin = 1000) #Shuffle adjacency matrix
  connectance_r00 <- apply(shuffled_r00, MARGIN = 3, connectance) # apply metric
  # P-value: Which proportion of the simulations have a Q value larger than the observed?
  P_value <- sum(connectance_vec[1] < connectance_r00)/length(connectance_r00)
  # if P-value is larger than 0.5, subtract it from 1
  if (P_value > 0.5){
    print("observed value is bigger than null value (did not say significant)")
    P_value <- 1 - P_value
  }
  print(paste0("P-value is: ",P_value))
  print(paste0("mean is: ", mean(connectance_r00)))
  print(paste0("sd is: ", sd(connectance_r00)))
  return(connectance_r00)
}

# connectance_sim1 <- null_r00_simulation(wild_web, connectance, num_iterations = 1000)
# connectance_sim2 <- null_r00_simulation(b_wild_web, connectance, num_iterations = 1000)
# connectance_sim3 <- null_r00_simulation(domestic_web, connectance, num_iterations = 1000)
# connectance_sim4 <- null_r00_simulation(b_domestic_web, connectance, num_iterations = 1000)

# now save the normalized (x / mean) value
# store it in a vector
connectance_norm <- c()
row_vec
connectance_norm[1] <- (omnivor::connectance(wild_web, loops = F, directed = F) / mean(connectance_sim1))
connectance_norm[2] <- (omnivor::connectance(b_wild_web, loops = F, directed = F) / mean(connectance_sim2))
connectance_norm[3] <- (omnivor::connectance(domestic_web, loops = F, directed = F) / mean(connectance_sim3))
connectance_norm[4] <- (omnivor::connectance(b_domestic_web, loops = F, directed = F) / mean(connectance_sim4))
connectance_norm


```
Connectance decreases when fungi is added.

## 4.2. Clustering coefficient (transitivity)
```{r}
# The ratio of the triangles connected to the vertex and the triples centered on the vertex.
transitivity(wild_web, type = 'local')
histogram(transitivity(wild_web, type = 'local'), col = 'pink')

# The ratio of the triangles and the connected triples in the whole graph
transitivity(wild_web, type = 'global') 

# store it in a vector
transitivity_vec <- c()
row_vec
transitivity_vec[1] <- transitivity(wild_web, type = 'global')
transitivity_vec[2] <- transitivity(b_wild_web, type = 'global')
transitivity_vec[3] <- transitivity(domestic_web, type = 'global')
transitivity_vec[4] <- transitivity(b_domestic_web, type = 'global')
transitivity_vec


# Randomization and null model to normalize summary metrics
# Use this transitivity function for simulation below
transitivity_in_matrix <- function(wild_mat){
  wild_web <- igraph::graph.adjacency(wild_mat, mode = 'undirected')
  trans <- transitivity(wild_web, type="global")
  return(trans)
}

# curveball
transitivity_sim1 <- null_curveball_simulation(wild_web, transitivity_in_matrix, num_iterations = 1000)
transitivity_sim2 <- null_curveball_simulation(b_wild_web, transitivity_in_matrix, num_iterations = 1000)
transitivity_sim3 <- null_curveball_simulation(domestic_web, transitivity_in_matrix, num_iterations = 1000)
transitivity_sim4 <- null_curveball_simulation(b_domestic_web, transitivity_in_matrix, num_iterations = 1000)

# r00
# transitivity_sim1 <- null_r00_simulation(wild_web, transitivity_in_matrix, num_iterations = 1000)
# transitivity_sim2 <- null_r00_simulation(b_wild_web, transitivity_in_matrix, num_iterations = 1000)
# transitivity_sim3 <- null_r00_simulation(domestic_web, transitivity_in_matrix, num_iterations = 1000)
# transitivity_sim4 <- null_r00_simulation(b_domestic_web, transitivity_in_matrix, num_iterations = 1000)

# now save the normalized (x - mean / sd) value = zscore
# store it in a vector
transitivity_zscore <- c()
row_vec
transitivity_zscore[1] <- (transitivity(wild_web, type = 'global') - mean(transitivity_sim1)) / sd(transitivity_sim1)
transitivity_zscore[2] <- (transitivity(b_wild_web, type = 'global') - mean(transitivity_sim2)) / sd(transitivity_sim2)
transitivity_zscore[3] <- (transitivity(domestic_web, type = 'global') - mean(transitivity_sim3)) / sd(transitivity_sim3)
transitivity_zscore[4] <- (transitivity(b_domestic_web, type = 'global') - mean(transitivity_sim4)) / sd(transitivity_sim4)
transitivity_zscore

# too high...

# now save the normalized (x / mean) value
# store it in a vector
transitivity_norm <- c()
row_vec
transitivity_norm[1] <- (transitivity(wild_web, type = 'global') / mean(transitivity_sim1))
transitivity_norm[2] <- (transitivity(b_wild_web, type = 'global') / mean(transitivity_sim2))
transitivity_norm[3] <- (transitivity(domestic_web, type = 'global') / mean(transitivity_sim3))
transitivity_norm[4] <- (transitivity(b_domestic_web, type = 'global') / mean(transitivity_sim4))
transitivity_norm

```
Transitivity decreases when fungi is added.

## 4.3. Modularity

Let's plot modular structure
```{r}
# Detect communities, note the as.undirected command
wild_unweighted <- wild_web
wild_unweighted <- as.undirected(wild_unweighted)
E(wild_unweighted)$weight <- 1

# implementing Louvain method
cl <- cluster_louvain(wild_unweighted) # Can also use the weights = NULL argument
class(cl) # the result is of class communities

# module membership & visualization
module_membership <- membership(cl)
table(module_membership)

# color
cols <- data.frame(mem=unique(module_membership), col= my_color_collection[1:length(unique(module_membership))])
V(wild_unweighted)$module_membership <- module_membership
V(wild_unweighted)$color <- cols$col[match(V(wild_unweighted)$module_membership, cols$mem)]

# shape: triangle fungi / circle bacteria
V(wild_unweighted)$shape <- ifelse(substr(V(wild_unweighted)$name,1,1)=="B","circle","csquare")

# plot network
plot(wild_unweighted, vertex.color=V(wild_unweighted)$color, vertex.size=6, edge.arrow.width=0.3, edge.arrow.curve=0.5, vertex.shape=V(wild_unweighted)$shape, vertex.label=NA)

```

Calculate modularity and use tidygraph
- Adapted from this resource: https://dgarcia-eu.github.io/SocialDataScience/5_SocialNetworkPhenomena/057_Tidygraph2/tidygraph2.html \
```{r}
library(ggraph)
library(tidygraph)

# convert igraph to tidygraph object
wild_tbl <- as_tbl_graph(wild_web)

# Louvain clustering
wild_tbl %<>%
  tidygraph::activate(nodes) %>% 
  mutate(community=as.character(group_louvain()))

# Modules / add bacteria or fungi info
wild_tbl %<>% 
  activate(nodes) %>% 
  mutate(Bacteria = ifelse(substr(name,1,1)=="B","Bacteria","Fungi") )

# plot again with ggraph
wild_tbl %>% 
  ggraph("fr")  + geom_edge_link()  + geom_node_point(aes(color=community, shape=Bacteria), size=4) + theme_graph()

# Modularity Q
wild_tbl %>% 
  activate(nodes) %>% 
  mutate(modularity = graph_modularity(group=community)) %>% 
  pull(modularity) %>% 
  head(1)

modularity_Q <- function(wild_web){
  # convert object
  wild_tbl <- as_tbl_graph(wild_web)
  # Louvain clustering
  wild_tbl %<>%
    tidygraph::activate(nodes) %>% 
    mutate(community=as.character(group_louvain()))
  # Modularity Q
  wild_tbl %>% 
    activate(nodes) %>% 
    mutate(modularity = graph_modularity(group=community)) %>% 
    pull(modularity) %>% 
    head(1)
}

# store Modularity Q in a vector
modularity_vec <- c()
row_vec
modularity_vec[1] <- modularity_Q(wild_web)
modularity_vec[2] <- modularity_Q(b_wild_web)
modularity_vec[3] <- modularity_Q(domestic_web)
modularity_vec[4] <- modularity_Q(b_domestic_web)
modularity_vec


# Randomization and null model to normalize summary metrics
# Use this transitivity function for simulation below
modularity_in_matrix <- function(wild_mat){
  wild_web <- igraph::graph.adjacency(wild_mat, mode = 'undirected')
  mod <- modularity_Q(wild_web)
  return(mod)
}

# curveball
modularity_sim1 <- null_curveball_simulation(wild_web, modularity_in_matrix, num_iterations = 1000)
modularity_sim2 <- null_curveball_simulation(b_wild_web, modularity_in_matrix, num_iterations = 1000)
modularity_sim3 <- null_curveball_simulation(domestic_web, modularity_in_matrix, num_iterations = 1000)
modularity_sim4 <- null_curveball_simulation(b_domestic_web, modularity_in_matrix, num_iterations = 1000)

# r00
# modularity_sim1 <- null_r00_simulation(wild_web, modularity_in_matrix, num_iterations = 1000)
# modularity_sim2 <- null_r00_simulation(b_wild_web, modularity_in_matrix, num_iterations = 1000)
# modularity_sim3 <- null_r00_simulation(domestic_web, modularity_in_matrix, num_iterations = 1000)
# modularity_sim4 <- null_r00_simulation(b_domestic_web, modularity_in_matrix, num_iterations = 1000)

# now save the normalized (x - mean / sd) value = zscore
# store it in a vector
modularity_zscore <- c()
row_vec
modularity_zscore[1] <- (modularity_Q(wild_web) - mean(modularity_sim1)) / sd(modularity_sim1)
modularity_zscore[2] <- (modularity_Q(b_wild_web) - mean(modularity_sim2)) / sd(modularity_sim2)
modularity_zscore[3] <- (modularity_Q(domestic_web) - mean(modularity_sim3)) / sd(modularity_sim3)
modularity_zscore[4] <- (modularity_Q(b_domestic_web) - mean(modularity_sim4)) / sd(modularity_sim4)
modularity_zscore
# too high...

# now save the normalized (x / mean) value
# store it in a vector
modularity_norm <- c()
row_vec
modularity_norm[1] <- (modularity_Q(wild_web) / mean(modularity_sim1))
modularity_norm[2] <- (modularity_Q(b_wild_web) / mean(modularity_sim2))
modularity_norm[3] <- (modularity_Q(domestic_web) / mean(modularity_sim3))
modularity_norm[4] <- (modularity_Q(b_domestic_web) / mean(modularity_sim4))
modularity_norm

```

## 4.4. Plot normalized summary statistics

```{r}
# make dataframe
df_summary <- tibble(Network = row_vec, Connectance = connectance_norm, Transitivity= transitivity_norm, Modularity= modularity_norm)

# Melt for plotting
melt_summary <- melt(df_summary)
colnames(melt_summary) <- c("Network","Stat","Normalized_metric")
melt_summary$Network <- factor(melt_summary$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))

# Plotting for visualiztion
ggplot(melt_summary, aes(x=Stat, y=Normalized_metric, group=Network, color=Network)) +
  geom_point(size =3.5, shape=16) +
  geom_line(size=0.5) +
  ggtitle(paste0("Network metrics comparison"," \n")) +
  xlab('\n Metric')+
  ylab("Normalized metric (x / mean(null_model)) \n") +
  scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
  scale_y_continuous(limits = c(0, max(melt_summary$Normalized_metric)), breaks=seq(0, max(melt_summary$Normalized_metric), 1)) +
  geom_hline(yintercept=1, color="maroon4", linetype='dotted', size=1.1) +
  mytheme_2d +
  theme(legend.title  = element_blank())+
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=17, family="serif"))

```

Just in case, plotting the metrics without normalization
```{r}
# make dataframe
df_summary_no_norm <- tibble(Network = row_vec, Connectance = connectance_vec, Transitivity= transitivity_vec, Modularity= modularity_vec)

# Melt for plotting
melt_summary_no_norm <- melt(df_summary_no_norm)
colnames(melt_summary_no_norm) <- c("Network","Stat","Metric")
melt_summary_no_norm$Network <- factor(melt_summary_no_norm$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))

# Plotting for visualiztion
ggplot(melt_summary_no_norm, aes(x=Stat, y=Metric, group=Network, color=Network)) +
  geom_point(size =3.5) +
  geom_line(size=0.5) +
  ggtitle(paste0("Network metrics comparison"," \n")) +
  xlab('\n Metric')+
  ylab("Non-normalized metric \n") +
  scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
  scale_y_continuous(limits = c(0, max(melt_summary_no_norm$Metric)), breaks=seq(0, max(melt_summary_no_norm$Metric), 0.1)) +
  # geom_hline(yintercept=1, color="maroon4", linetype='dotted', size=1.1) +
  mytheme_2d +
  theme(legend.title  = element_blank())+
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=17, family="serif"))

```

Just in case, plotting the zscore normalized metric.
- Warning: connectance is not zscore normalized due to sd(null) being 0. It is just divided by mean(null).
```{r}
# make dataframe
df_summary_zscore <- tibble(Network = row_vec, Connectance = connectance_norm, Transitivity= transitivity_zscore, Modularity= modularity_zscore)

# Melt for plotting
melt_summary_zscore <- melt(df_summary_zscore)
colnames(melt_summary_zscore) <- c("Network","Stat","Metric")
melt_summary_zscore$Network <- factor(melt_summary_zscore$Network, levels = c('Wild-Bacterial-Fungal','Wild-Bacterial','Domesticated-Bacterial-Fungal',"Domesticated-Bacterial"))

# Plotting for visualiztion
ggplot(melt_summary_zscore, aes(x=Stat, y=Metric, group=Network, color=Network)) +
  geom_point(size =3.5) +
  geom_line(size=0.5) +
  ggtitle(paste0("Network metrics comparison"," \n")) +
  xlab('\n Metric')+
  ylab("Zscore-normalized metric \n") +
  scale_color_manual(values = c("red2",'gold1','blue3','cyan2'))+
  scale_y_continuous(limits = c(0, max(melt_summary_zscore$Metric)), breaks=seq(0, max(melt_summary_zscore$Metric), 10)) +
  # geom_hline(yintercept=1, color="maroon4", linetype='dotted', size=1.1) +
  mytheme_2d +
  theme(legend.title  = element_blank())+
  theme(axis.text.x = element_text(hjust = 0.5, vjust=0.3,size=17, family="serif"))

```

## 5. Bacterial-fungal Bipartite network and Nestedness
- Exclude all the Bacterial-bacterial interaction \
- Exclude all the Fungal-Fungal interaction \
- Only leave Bacterial-Fungal interaction \
- Convert to bipartite matrix
```{r}
# Prune and make it into Bipartite
get.edgelist(wild_web) %>% dim()
wild_edge <- get.edgelist(wild_web) 
class(wild_edge)
wild_edge <- data.frame(wild_edge)
dim(wild_edge) # 673

# classify the edge type
wild_edge$type <- paste0(substr(wild_edge$X1,1,1), substr(wild_edge$X2,1,1))

# filter out BB (bac-bac interaction) and FF (Fungal-Fungal interaction)
wild_edge_BF <- wild_edge %>% filter(type %in% c("FB","BF")) # 303/673 = 45%

# need to put bacteria to the left column, and fungi to the right column
wild_edge_new <- wild_edge_BF
for (i in 1:dim(wild_edge_BF)[1]){
  if (wild_edge_BF$type[i] == "FB"){
    wild_edge_new[i,1] <- wild_edge_BF[i,2]
    wild_edge_new[i,2] <- wild_edge_BF[i,1]
  }
}
# remove type column
wild_edge_BFn <- wild_edge_new %>% dplyr::select(-type)
colnames(wild_edge_BFn)

# bipartite adjacency network
wild_bipartite_mat <- table(wild_edge_BFn$X1,wild_edge_BFn$X2)
dim(wild_bipartite_mat)
class(wild_bipartite_mat)

# Compute metrics
nl_metrics <- networklevel(wild_bipartite_mat)
nl_metrics[7]
nl_metrics[8]
```

Function and apply to all networks
```{r}
# get nestedness

get_bipartite <- function(wild_web){
  # Prune and make it into Bipartite
  get.edgelist(wild_web) %>% dim()
  wild_edge <- get.edgelist(wild_web) 
  class(wild_edge)
  wild_edge <- data.frame(wild_edge)
  dim(wild_edge) # 673
  
  # classify the edge type
  wild_edge$type <- paste0(substr(wild_edge$X1,1,1), substr(wild_edge$X2,1,1))
  
  # filter out BB (bac-bac interaction) and FF (Fungal-Fungal interaction)
  wild_edge_BF <- wild_edge %>% filter(type %in% c("FB","BF")) # 303/673 = 45%
  
  # need to put bacteria to the left column, and fungi to the right column
  wild_edge_new <- wild_edge_BF
  for (i in 1:dim(wild_edge_BF)[1]){
    if (wild_edge_BF$type[i] == "FB"){
      wild_edge_new[i,1] <- wild_edge_BF[i,2]
      wild_edge_new[i,2] <- wild_edge_BF[i,1]
    }
  }
  # remove type column
  wild_edge_BFn <- wild_edge_new %>% dplyr::select(-type)
  colnames(wild_edge_BFn)
  
  # bipartite adjacency network
  wild_bipartite_mat <- table(wild_edge_BFn$X1,wild_edge_BFn$X2)
  dim(wild_bipartite_mat)
  class(wild_bipartite_mat)
  
  return(wild_bipartite_mat)
}

wild_bipartite_mat <- get_bipartite(wild_web)
dom_bipartite_mat <- get_bipartite(domestic_web)

# Compute metrics
nl_wild <- networklevel(wild_bipartite_mat)
nl_dom <- networklevel(dom_bipartite_mat)

# wild
nl_wild[c(7,8)]
# domesticated
nl_dom[c(7,8)]

```

Plot and visualize
```{r}
# NODF
nodf_w <- nestednodf(wild_bipartite_mat)
nodf_d <- nestednodf(dom_bipartite_mat)

# Wild
plot(nodf_w, col='red',
       xlab="Fungi", ylab="Bacteria",
       main="Wild (NODF=2.0125, p-value=0.019)")
plot(nodf_d, col='red',
       xlab="Fungi", ylab="Bacteria",
       main="Domesticated (NODF=2.2463, p-value=0.988)")

nest_sim_wild_cb <- oecosimu(wild_bipartite_mat, nestednodf, 'curveball', nsimul = 1000)
nest_sim_wild_r00 <- oecosimu(wild_bipartite_mat, nestednodf, 'r00', nsimul = 1000)

nest_sim_dom_cb <- oecosimu(dom_bipartite_mat, nestednodf, 'curveball', nsimul = 1000)
nest_sim_dom_r00 <- oecosimu(dom_bipartite_mat, nestednodf, 'r00', nsimul = 1000)

```

## 6. Motif

```{r}
par(mfrow=c(4,4), mar=c(.75,.75,.75,.75))
for (i in 0:15){ # note that counting starts at 0
  plot(graph_from_isomorphism_class(size = 3, number = i),
       edge.arrow.size = 0.4,
       edge.color='black',
       main = i + 1)
  box(col='red')
}
dev.off()

motifs(wild_web) # absolute numbers
motifs(wild_web)/count_motifs(wild_web) # Proportion

# plotting motif function

plot_motif <- function(wild_web, title = "Motif relative abundance (Wild)"){
  df_motif <- data.frame(relative_abun=motifs(wild_web)/count_motifs(wild_web))
  df_motif <- tibble::rownames_to_column(df_motif, var='motif_n')
  ggplot(data=df_motif, aes(x=motif_n, y=relative_abun)) +
    geom_bar(stat="identity") +
    ggtitle(paste0(title," \n")) +
    xlab('\n Motif number')+
    ylab("Relative abundance  \n") +
    mytheme
}

mt1 <- plot_motif(wild_web, title = "Wild-Bacteria-Fungi")
mt2 <- plot_motif(b_wild_web, title = "Wild-Bacteria")
# plot_motif(f_wild_web, title = "Motif relative abundance (Wild)")

mt3 <- plot_motif(domestic_web, title = "Domesticated-Bacteria-Fungi")
mt4 <- plot_motif(b_domestic_web, title = "Domesticated-Bacteria")
# plot_motif(f_domestic_web, title = "Motif relative abundance (Wild)")

# plot 4 in 1
ggarrange(mt1, mt2 + rremove("ylab"), mt3, mt4 + rremove("ylab"),# + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)

```
Nothing noteworthy.

## 7. Module further analysis
Maybe more module analysis could be done.
Modularity visualization
```{r}

plot_graph_module <- function(wild_web){
  # convert igraph to tidygraph object
  wild_tbl <- as_tbl_graph(wild_web)
  # Louvain clustering
  wild_tbl %<>%
    tidygraph::activate(nodes) %>% 
    mutate(community=as.character(group_louvain()))
  
  # Modules / add bacteria or fungi info
  wild_tbl %<>% 
    activate(nodes) %>% 
    mutate(Bacteria = ifelse(substr(name,1,1)=="B","Bacteria","Fungi") )
  # plot again with ggraph
  wild_tbl %>% 
    ggraph("fr")  + geom_edge_link()  + geom_node_point(aes(color=community, shape=Bacteria), size=3) + theme_graph() 
}

# plot
ggr1 <- plot_graph_module(wild_web)
ggr2 <- plot_graph_module(b_wild_web)
# plot_graph_module(f_wild_web)
ggr3 <- plot_graph_module(domestic_web)
ggr4 <- plot_graph_module(b_domestic_web)
# plot_graph_module(f_domestic_web)

ggarrange(ggr1 + rremove("legend"), ggr2 + rremove("legend"), ggr3 + rremove("legend"), ggr4 + rremove("legend"), # + rremove("x.text") 
          labels = c("A", "B", "C", "D"),
          ncol = 2, nrow = 2)

ggarrange(ggr1, ggr2, ggr3, ggr4,
          labels = c("A", "B", "C","D"),
          ncol = 2, nrow = 2)

```

